<!-- pages/longqiao/longqiao.wxml -->
<!-- åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ  WXS æ¨¡å— -->
<wxs module="format">
  // æ ¼å¼åŒ–æ•°å­—ä¸ºåƒåˆ†ä½æ˜¾ç¤º
  function formatNumber(num) {
    if (num == null || num === '' || num === undefined) return '0.00'
    
    var n = parseFloat(num)
    if (isNaN(n)) return '0.00'
    
    // ä¿ç•™ä¸¤ä½å°æ•°
    var fixed = n.toFixed(2)
    var parts = fixed.split('.')
    var integerPart = parts[0]
    var decimalPart = parts[1]
    
    // å¤„ç†è´Ÿæ•°
    var isNegative = integerPart.charAt(0) === '-'
    if (isNegative) {
      integerPart = integerPart.substring(1)
    }
    
    // æ·»åŠ åƒä½åˆ†éš”ç¬¦
    var formatted = ''
    var length = integerPart.length
    
    for (var i = 0; i < length; i++) {
      if (i > 0 && (length - i) % 3 === 0) {
        formatted += ','
      }
      formatted += integerPart.charAt(i)
    }
    
    if (isNegative) {
      formatted = '-' + formatted
    }
    
    return formatted + '.' + decimalPart
  }
  
  // æ ¼å¼åŒ–æ•°é‡ï¼ˆä¸éœ€è¦å°æ•°ä½ï¼‰
  function formatQuantity(num) {
    if (num == null || num === '' || num === undefined) return '0'
    
    var n = parseFloat(num)
    if (isNaN(n)) return '0'
    
    var integerPart = Math.floor(n).toString()
    
    // å¤„ç†è´Ÿæ•°
    var isNegative = integerPart.charAt(0) === '-'
    if (isNegative) {
      integerPart = integerPart.substring(1)
    }
    
    // æ·»åŠ åƒä½åˆ†éš”ç¬¦
    var formatted = ''
    var length = integerPart.length
    
    for (var i = 0; i <length; i++) {
      if (i > 0 && (length - i) % 3 === 0) {
        formatted += ','
      }
      formatted += integerPart.charAt(i)
    }
    
    if (isNegative) {
      formatted = '-' + formatted
    }
    
    return formatted
  }
  
  // æ ¼å¼åŒ–å•ä»·ï¼ˆä¿ç•™ä¸¤ä½å°æ•°ï¼‰
  function formatPrice(num) {
    return formatNumber(num)
  }
  
  module.exports = {
    formatNumber: formatNumber,
    formatQuantity: formatQuantity,
    formatPrice: formatPrice
  }
</wxs>

<view class="page-container">
  <view class="content">
    <!-- é¡¶éƒ¨ç”¨æˆ·ä¿¡æ¯æ  -->
  <view class="user-header">
    <view class="user-info" bindtap="onUserMenu">
      <image class="user-avatar" src="{{userAvatar}}"></image>
      <view class="user-details">
        <text class="user-email">{{userEmail || 'å“ç‰Œç”¨æˆ·'}}</text>
        <text class="user-status">å·²ç™»å½•</text>
      </view>
      <text class="dropdown-icon">â–¼</text>
    </view>
    <view class="header-actions">
      <button class="btn-refresh" size="mini" bindtap="onRefresh">åˆ·æ–°</button>
    </view>
  </view>

  <!-- ç¬¬ä¸€ç‰ˆå—ï¼šæ•°æ®ç­›é€‰ï¼ˆéš†æ¡¥ä»“åº“ä¸‰è¡Œå¸ƒå±€ï¼‰ -->
  <view class="card">
    <view class="card-header">
      <text class="card-title">âŒ› æ•°æ®ç­›é€‰</text>
    </view>
    
    <view class="card-body">
      <view class="filter-grid">
        <!-- ç¬¬ä¸€è¡Œï¼šæ—¥æœŸç­›é€‰ -->
        <view class="filter-group">
          <view class="filter-item">
            <text class="filter-label">ğŸ“…å¼€å§‹æ—¥æœŸ</text>
            <picker mode="date" value="{{startDateStr}}" start="2024-01-01" end="{{endDateStr}}" bindchange="onStartDateChange">
              <view class="picker">{{startDateStr || 'é€‰æ‹©å¼€å§‹æ—¥æœŸ'}}</view>
            </picker>
          </view>
          
          <view class="filter-item">
            <text class="filter-label">ğŸ“…ç»“æŸæ—¥æœŸ</text>
            <picker mode="date" value="{{endDateStr}}" start="{{startDateStr}}" end="2050-12-31" bindchange="onEndDateChange">
              <view class="picker">{{endDateStr || 'é€‰æ‹©ç»“æŸæ—¥æœŸ'}}</view>
            </picker>
          </view>
        </view>
        
        <!-- ç¬¬äºŒè¡Œï¼šé”€å”®äººå‘˜ + å®¢æˆ·åç§° -->
        <view class="filter-group">
          <view class="filter-item">
            <text class="filter-label">ğŸ‘¤é”€å”®äººå‘˜</text>
            <picker mode="selector" range="{{salespersons}}" value="{{selectedSalespersonIndex}}" bindchange="onSalespersonChange">
              <view class="picker">{{salespersons[selectedSalespersonIndex] || 'é€‰æ‹©äººå‘˜'}}</view>
            </picker>
          </view>
          
          <view class="filter-item">
            <text class="filter-label">ğŸ¢å®¢æˆ·åç§°</text>
            <picker mode="selector" range="{{customers}}" value="{{selectedCustomerIndex}}" bindchange="onCustomerChange">
              <view class="picker">{{customers[selectedCustomerIndex] || 'é€‰æ‹©å®¢æˆ·'}}</view>
            </picker>
          </view>
        </view>
        
        <!-- ç¬¬ä¸‰è¡Œï¼šå“ç‰Œ + å•†å“åç§° -->
        <view class="filter-group">
          <view class="filter-item">
            <text class="filter-label">ğŸ·ï¸å“ç‰Œåç§°</text>
            <picker mode="selector" range="{{brands}}" value="{{selectedBrandIndex}}" bindchange="onBrandChange">
              <view class="picker">{{brands[selectedBrandIndex] || 'é€‰æ‹©å“ç‰Œ'}}</view>
            </picker>
          </view>
          
          <view class="filter-item">
            <text class="filter-label">ğŸå•†å“åç§°</text>
            <picker mode="selector" range="{{products}}" value="{{selectedProductIndex}}" bindchange="onProductChange">
              <view class="picker">{{products[selectedProductIndex] || 'é€‰æ‹©å•†å“'}}</view>
            </picker>
          </view>
        </view>
      </view>

      <view class="filter-actions">
        <button class="btn btn-secondary" bindtap="onClearFilter" >ğŸ§½æ¸…é™¤ç­›é€‰</button>
        <button class="btn btn-primary" bindtap="onQueryData">ğŸ”æŸ¥è¯¢æ•°æ®</button>
      </view>
    </view>
  </view>

  <!-- ç¬¬äºŒç‰ˆå—ï¼šæ•°æ®æ±‡æ€»ï¼ˆéš†æ¡¥ä»“åº“å¡ç‰‡è°ƒæ•´ï¼‰ -->
  <view class="card">
    <view class="card-header">
      <text class="card-title">ğŸ“ˆ æ•°æ®æ±‡æ€»</text>
    </view>
    
    <view class="card-body">
      <!-- 1. ç»Ÿè®¡å¡ç‰‡ï¼ˆæ€»ä»¶æ•°ã€æ€»é‡‘é¢ã€æ€»æ¯›åˆ©ã€æ€»è´¹ç”¨ï¼‰ -->
      <view class="summary-grid">
        <view class="stat-card">
          <view class="stat-content">
            <text class="stat-label">ğŸ“¦æ€»ä»¶æ•°</text>
            <text class="stat-value">{{totalQuantity}}</text>
          </view>
        </view>
        
        <view class="stat-card">
          <view class="stat-content">
            <text class="stat-label">ğŸ’°æ€»é‡‘é¢</text>
            <text class="stat-value">Â¥{{totalAmount}}</text>
          </view>
        </view>
        
        <view class="stat-card">
          <view class="stat-content">
            <text class="stat-label">ğŸª™æ€»æ¯›åˆ©</text>
            <text class="stat-value" style="color:#1eac31;">Â¥{{totalGrossProfit}}</text>
          </view>
        </view>
        
        <view class="stat-card">
          <view class="stat-content">
            <text class="stat-label">ğŸ›’æ€»è´¹ç”¨</text>
            <text class="stat-value" style="color: rgb(229, 62, 62);">Â¥{{totalCost}}</text>
          </view>
        </view>
      </view>

      <!-- 2. å“ç‰Œæ±‡æ€»è¡¨æ ¼ï¼ˆå¢åŠ æ€»æ¯›åˆ©ã€æ€»è´¹ç”¨åˆ—ï¼‰ -->
      <view class="brand-summary-section" wx:if="{{brandSummary.length > 0}}">
        <view class="section-header">
          <text class="section-title">ğŸ“Š {{selectedSalespersonIndex > 0 ? 'å•†å“æ±‡æ€»' : (selectedBrandIndex > 0 ? 'äººå‘˜æ±‡æ€»' : 'å“ç‰Œæ±‡æ€»')}} ({{brandSummary.length}}ä¸ª)</text>
        </view>
        
        <view class="brand-table-container">
          <view class="brand-table">
            <scroll-view class="brand-table-body" scroll-x="true" scroll-y="true" style="height: 578rpx;">
              <view class="brand-table-body-content" style="min-width: 1000rpx;">
                <!-- å›ºå®šè¡¨å¤´ -->
                <view class="brand-table-header sticky-header">
                  <text class="brand-cell header-cell {{selectedSalespersonIndex > 0 ? 'brand-cell-salesperson' : ''}}">{{selectedSalespersonIndex > 0 ? 'å•†å“åç§°' : (selectedBrandIndex > 0 ? 'ä¸šåŠ¡å‘˜' : 'å“ç‰Œ')}}</text>
                  <text class="brand-cell header-cell">æ€»ä»¶æ•°</text>
                  <text class="brand-cell header-cell">æ€»é‡‘é¢</text>
                  <text class="brand-cell header-cell">å æ¯”</text>
                  <text class="brand-cell header-cell">æ€»æ¯›åˆ©</text>
                  <text class="brand-cell header-cell">æ€»è´¹ç”¨</text>
                </view>
                
                <view class="brand-table-rows">
                  <view class="brand-table-row" wx:for="{{brandSummary}}" wx:key="index">
                    <text class="brand-cell {{selectedSalespersonIndex > 0 ? 'brand-cell-salesperson' : ''}}">{{item.brand}}</text>
                    <text class="brand-cell">{{item.quantityFormatted || item.quantity}}</text>
                    <text class="brand-cell">Â¥{{item.amountFormatted || item.amount}}</text>
                    <text class="brand-cell">{{item.percentage}}%</text>
                    <text class="brand-cell">Â¥{{item.grossProfitFormatted || item.grossProfit}}</text>
                    <text class="brand-cell">Â¥{{item.costFormatted || item.cost}}</text>
                  </view>
                </view>
              </view>
            </scroll-view>
          </view>
        </view>
      </view>

    </view>
  </view>

  <!-- ç¬¬ä¸‰ç‰ˆå—ï¼šè¯¦ç»†é”€å”®è®°å½•ï¼ˆéš†æ¡¥ä»“åº“åˆ—é¡ºåºè°ƒæ•´ï¼‰ -->
  <view class="card">
    <view class="card-header">
      <view class="header-left">
        <text class="card-title">ğŸ“‹è¯¦ç»†é”€å”®è®°å½•</text>
        <text class="detail-count">({{detailCount}}æ¡)</text>
      </view>
      <view class="header-right">
        <button class="toggle-icon" bindtap="toggleDetail">
          <text>{{showDetail ? 'â–²æ”¶èµ·' : 'â–¼å±•å¼€'}}</text>
        </button>
        <button class="btn-export" bindtap="exportData" wx:if="{{detailCount > 0}}">ğŸ“¥å¯¼å‡º</button>        
      </view>
    </view>
    
    <view class="card-body-detail">
      <view class="detail-section" wx:if="{{showDetail && detailList.length > 0}}">
        <view class="table-container">
          <view class="table">
            <scroll-view 
              class="table-body" 
              scroll-x="true" 
              scroll-y="true"
              style="height: 500rpx; width: 100%;"
            >
              <view class="table-body-content" style="min-width: 1600rpx;">
                <!-- å›ºå®šè¡¨å¤´ -->
                <view class="table-header sticky-header">
                  <text class="cell">é”€å”®æ—¥æœŸ</text>
                  <text class="cell cell-customer">å®¢æˆ·åç§°</text>
                  <text class="cell cell-product-name">å•†å“åç§°</text>
                  <text class="cell cell-sales">é”€å”®äººå‘˜</text>
                  <text class="cell cell-quantity">é”€å”®æ•°é‡</text>
                  <text class="cell cell-amount">é”€å”®é‡‘é¢</text>
                  <text class="cell cell-cost">å•†å“æˆæœ¬</text>
                  <text class="cell cell-profit">é”€å”®æ¯›åˆ©</text>
                </view>
                
                <view class="table-rows">
                  <view class="table-row" wx:for="{{detailList}}" wx:key="index">
                    <text class="cell">{{item.sale_date}}</text>
                    <text class="cell cell-customer">{{item.customer}}</text>
                    <text class="cell cell-product-name">{{item.product_name}}</text>
                    <text class="cell cell-sales">{{item.sales}}</text>
                    <!-- ä½¿ç”¨ formatQuantity æ ¼å¼åŒ–æ•°é‡ -->
                    <text class="cell cell-quantity">{{format.formatQuantity(item.quantity)}}</text>
                    <!-- ä½¿ç”¨ formatNumber æ ¼å¼åŒ–é‡‘é¢ -->
                    <text class="cell cell-amount">Â¥{{format.formatNumber(item.amount)}}</text>
                    <!-- ä½¿ç”¨ formatNumber æ ¼å¼åŒ–æˆæœ¬ -->
                    <text class="cell cell-cost">Â¥{{format.formatNumber(item.cost)}}</text>
                    <!-- ä½¿ç”¨ formatNumber æ ¼å¼åŒ–æ¯›åˆ© -->
                    <text class="cell cell-profit">Â¥{{format.formatNumber(item.gross_profit)}}</text>
                  </view>
                </view>
              </view>
            </scroll-view>
          </view>
        </view>
      </view>
      
      <view class="no-data" wx:if="{{detailList.length === 0}}">
        <text class="no-data-icon">ğŸ“­</text>
        <text class="no-data-text">æš‚æ— è¯¦ç»†è®°å½•</text>
      </view>
      
      <view class="detail-collapsed" wx:if="{{!showDetail && detailCount > 0}}">
        <text class="hint-text">ç‚¹å‡»"å±•å¼€"æŸ¥çœ‹ {{detailCount}} æ¡è¯¦ç»†è®°å½•</text>
      </view>
    </view>
  </view>
  </view>

  <!-- åŠ è½½åŠ¨ç”» -->
  <view class="loading-overlay" wx:if="{{isLoading}}">
    <view class="loading-content">
      <view class="spinner"></view>
      <text class="loading-text">æ­£åœ¨åŠ è½½æ•°æ®...</text>
    </view>
  </view>

  <view class="loading-overlay" wx:if="{{isDetailLoading}}">
    <view class="loading-content">
      <view class="spinner"></view>
      <text class="loading-text">æ­£åœ¨åŠ è½½æ•°æ®...</text>
    </view>
  </view>
</view>