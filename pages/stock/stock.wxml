<!--pages/stock/stock.wxml-->
<view class="page-container">
  <view class="content">

    <!-- é¡¶éƒ¨ç”¨æˆ·ä¿¡æ¯æ  -->
    <view class="user-header">
      <view class="user-info" bindtap="onUserMenu">
        <image class="user-avatar" src="/images/guanjiapo.png"></image>
        <view class="user-details">
          <text class="user-email">{{userName || 'ç®¡å®¶å©†ç”¨æˆ·'}}</text>
          <text class="user-status {{authStatus.class}}">{{authStatus.text}}</text>
        </view>
        <text class="dropdown-icon">â–¼</text>
      </view>
      <view class="header-actions">
        <button class="btn-refresh" size="mini" bindtap="clearGuanjiapoAuth">é€€å‡ºç™»å½•</button>
      </view>
    </view>

    <!-- ç™»å½•è¡¨å•ï¼ˆæœªç™»å½•æ—¶æ˜¾ç¤ºï¼‰ -->
    <view wx:if="{{showLogin}}" class="card login-card">
      <view class="card-header">
        <text class="card-title">ğŸ” ç®¡å®¶å©†ç™»å½•</text>
      </view>
      
      <view class="card-body">
        <view class="login-form">
          <view class="form-item">
            <text class="form-label">å…¬å¸åç§°ï¼š</text>
            <input class="form-input" 
                   value="{{loginForm.companyName}}" 
                   placeholder="è¯·è¾“å…¥å…¬å¸åç§°"
                   data-field="companyName"
                   bindinput="onLoginInput" />
          </view>
          
          <view class="form-item">
            <text class="form-label">ç”¨æˆ·åï¼š</text>
            <input class="form-input" 
                   value="{{loginForm.username}}" 
                   placeholder="è¯·è¾“å…¥ç”¨æˆ·å"
                   data-field="username"
                   bindinput="onLoginInput" />
          </view>
          
          <view class="form-item">
            <text class="form-label">å¯†ç ï¼š</text>
            <input class="form-input" 
                   value="{{loginForm.password}}" 
                   placeholder="è¯·è¾“å…¥å¯†ç "
                   password
                   data-field="password"
                   bindinput="onLoginInput" />
          </view>
          
          <view class="form-actions">
            <button class="btn btn-primary" bindtap="testGuanjiapoLogin" loading="{{isLoggingIn}}" disabled="{{isLoggingIn}}">
              ç™»å½•
            </button>
          </view>
        </view>
      </view>
    </view>

    <!-- ç¬¬ä¸€ç‰ˆå—ï¼šæ•°æ®ç­›é€‰ -->
    <view wx:if="{{!showLogin}}" class="card">
      <view class="card-header">
        <text class="card-title">â³ æ•°æ®ç­›é€‰</text>
      </view>
      
      <view class="card-body">
        <view class="filter-grid">
          <view class="filter-group">
            <view class="filter-item">
              <text class="filter-label">ğŸ·ï¸å“ç‰Œåç§°</text>
              <picker 
                class="picker" 
                mode="selector" 
                range="{{brandOptions}}" 
                range-key="text"
                value="{{selectedBrandIndex}}"
                bindchange="onBrandPickerChange">
                <view class="picker-display">
                  {{selectedBrandName || 'è¯·é€‰æ‹©å“ç‰Œ'}}
                </view>
              </picker>
            </view>
            
            <view class="filter-item">
              <text class="filter-label">ğŸå•†å“åç§°</text>
              <picker 
                class="picker" 
                mode="selector" 
                range="{{productOptions}}" 
                range-key="text"
                value="{{selectedProductIndex}}"
                bindchange="onProductPickerChange">
                <view class="picker-display">
                  {{selectedProductName || 'è¯·é€‰æ‹©å•†å“'}}
                </view>
              </picker>
            </view>
          </view>
        </view>

        <view class="filter-actions">
          <button class="btn btn-secondary" bindtap="clearFilter" >ğŸ§½æ¸…é™¤ç­›é€‰</button>
          <button class="btn btn-primary" bindtap="queryStockData" loading="{{isQuerying}}" disabled="{{isQuerying}}">ğŸ”æ•°æ®æŸ¥è¯¢</button>
        </view>
      </view>
    </view>

    <!-- ç¬¬äºŒç‰ˆå—ï¼šæ•°æ®æ±‡æ€»ï¼ˆåˆå¹¶ç»Ÿè®¡å¡ç‰‡å’Œå•†å“åˆ—è¡¨ï¼‰ -->
    <view wx:if="{{!showLogin}}" class="card">
      <view class="card-header">
        <text class="card-title">ğŸ“ˆ æ•°æ®æ±‡æ€»</text>
      </view>
      
      <view class="card-body">
        <!-- 1. ç»Ÿè®¡å¡ç‰‡ -->
        <view class="summary-grid">
          <view class="stat-card">
            <view class="stat-content">
              <text class="stat-label" wx:if="{{displayMode === 'brand'}}">ğŸ·ï¸å“ç‰Œç§ç±»</text>
              <text class="stat-label" wx:else>ğŸ›ï¸å•†å“ç§ç±»</text>
              <text class="stat-value">{{summaryCards.productTypes}}</text>
            </view>
          </view>
          
          <view class="stat-card">
            <view class="stat-content">
              <text class="stat-label">ğŸ“¦æ€»åº“å­˜(ä»¶)</text>
              <text class="stat-value">{{summaryCards.totalStock}}</text>
            </view>
          </view>
        </view>

        <!-- 2. å•†å“æ±‡æ€»è¡¨æ ¼ -->
        <view class="brand-summary-section" wx:if="{{filteredStockData.length > 0}}">
          <view class="section-header">
            <view class="section-header-left">
              <text class="section-title" wx:if="{{displayMode === 'brand'}}">ğŸ“‹å“ç‰Œæ±‡æ€» ({{filteredStockData.length}}ä¸ª)</text>
              <text class="section-title" wx:else>ğŸ“‹å•†å“æ±‡æ€» ({{filteredStockData.length}}ä¸ª)</text>
            </view>
            <view class="section-header-right">
              <button class="btn-share" size="mini" bindtap="shareAsImage">ğŸ“¤åˆ†äº«å›¾ç‰‡</button>
            </view>
          </view>
          
          <view class="brand-table-container">
            <view class="brand-table">
              <scroll-view class="brand-table-body" scroll-x="true" scroll-y="true" style="height: 500rpx;">
                <view class="brand-table-body-content" style="min-width: 600rpx;">
                  <!-- å›ºå®šè¡¨å¤´ -->
                  <view class="brand-table-header sticky-header">
                    <text class="brand-cell header-cell" wx:if="{{displayMode === 'brand'}}">å“ç‰Œç¼–å·</text>
                    <text class="brand-cell header-cell" wx:else>å•†å“ç¼–å·</text>
                    <text class="brand-cell header-cell brand-cell-wide" wx:if="{{displayMode === 'brand'}}">å“ç‰Œåç§°</text>
                    <text class="brand-cell header-cell brand-cell-wide" wx:else>å•†å“åç§°</text>
                    <text class="brand-cell header-cell">æ€»ä»¶æ•°</text>
                  </view>
                  
                  <view class="brand-table-rows">
                    <view class="brand-table-row" wx:if="{{filteredStockData.length > 0}}" wx:for="{{filteredStockData}}" wx:key="index">
                      <text class="brand-cell">{{item.userCode}}</text>
                      <text class="brand-cell brand-cell-wide">{{item.productName}}</text>
                      <text class="brand-cell">{{item.unitQuantity}}</text>
                    </view>
                  </view>
                </view>
              </scroll-view>
            </view>
          </view>
        </view>
        
        <view class="no-data" wx:if="{{filteredStockData.length === 0}}">
          <text class="no-data-icon">ğŸ“­</text>
          <text class="no-data-text">æš‚æ— åº“å­˜æ•°æ®</text>
        </view>
      </view>
    </view>

    <!-- æŸ¥è¯¢ç»“æœæç¤º -->
    <view wx:if="{{queryResult}}" class="test-result">
      <text class="result-title">çŠ¶æ€ï¼š</text>
      <text class="result-content">{{queryResult}}</text>
    </view>

    <view class="loading-overlay" wx:if="{{isLoggingIn}}">
      <view class="loading-content">
        <view class="spinner"></view>
        <text class="loading-text">æ­£åœ¨ç™»å½•...</text>
      </view>
    </view>

    <view class="loading-overlay" wx:if="{{isQuerying}}">
      <view class="loading-content">
        <view class="spinner"></view>
        <text class="loading-text">æ­£åœ¨æŸ¥è¯¢åº“å­˜æ•°æ®...</text>
      </view>
    </view>

    <!-- éšè—çš„canvasï¼Œç”¨äºç”Ÿæˆåˆ†äº«å›¾ç‰‡ -->
    <view class="hidden-canvas">
      <canvas id="shareCanvas" type="2d" style="position: fixed; top: -9999rpx; left: -9999rpx; width: 600rpx; height: 800rpx;"></canvas>
    </view>
  </view>
</view>